==================================================================
               Mystic Nights Server Interface Control Document
==================================================================
Version: 0.6.8
Date:    2024-06-04

This document describes the binary packet protocol between the Mystic Nights
game client and server. Packets are listed by direction, with structure
definitions and descriptions where available.

+----------------+------------------------------------------------+
| Packet ID      | Handler Function / Description                 |
+----------------+------------------------------------------------+
| 0x03f5         | FUN_0020bc20                                   |
| 0x0bc8         | FUN_00213c80       Lobby List Packet           |
| 0x0bbb         | FUN_002112f0       Channel List Packet         |
| 0x0bc7         | FUN_0021c910       Server List Packet          |
| 0x0bc6         | FUN_0021e490       Map Select Ack              |
| 0x0bc5         | FUN_0021e4c0       Character Select Ack        |
| 0x0bc4         | FUN_0021e4f0       Character Select Setup      |
| 0x0bc3         | FUN_0021e560       Player Kick Ack             |
| 0x0bc2         | FUN_0021e590       Lobby Leave Ack             |
| 0x0bc1         | FUN_0021e5c0                                   |
| 0x0bc0         | FUN_0021e5f0                                   |
| 0x0bbf         | FUN_00213c50       Lobby Join Ack              |
| 0x0bbe         | FUN_00213c50       Lobby Join Ack              |
| 0x0bbd         | FUN_002120f0       Lobby Create Ack            |
| 0x0bbc         | FUN_002112c0       Channel Join Ack            |
| 0x0bba         | FUN_00219ed0       Account Create/Delete Ack   |
| 0x0bb9         | FUN_00219ed0       Account Create/Delete Ack   |
| 0x0bb8 (3000)  | FUN_00203cf0       Login Ack                   |
| 0x03ee         | FUN_0021e6c0       Lobby Data Packet           |
| 0x03e9         | FUN_0011cd30                                   |
+----------------+------------------------------------------------+

==================================================================
I.  Client -> Server Packets
==================================================================

+--------------------------+----------+--------------------+------------------------------------------------+
| Packet Name              | PacketID | Structure Defined? | Description                                    |
+--------------------------+----------+--------------------+------------------------------------------------+
| Account Create           | 0x07d1   | Yes                | Client requests new account creation.          |
| Channel Join             | 0x07d4   | Partial            | Client requests to join a channel.             |
| Channel List Request     | 0x07d3   | No                 | Client requests list of channels.              |
| Lobby Create Request     | 0x07d5   | Partial            | Client requests creation of a new lobby.       |
| Lobby Join Request       | 0x07d6   | Partial            | Client requests to join an existing lobby.     |
| Game Start Request       | 0x07d8   | Partial            | Client requests to start the game.             |
| Lobby List Request       | 0x07e0   | No                 | Client requests multiplayer lobby list.        |
| Login Request            | 0x07d0   | No                 | Client requests to log in.                     |
| Server List Request      | 0x07df   | No                 | Client requests list of servers.               |
| Lobby Leave Request      | 0x07da   | Yes                | Client requests for player to leave the lobby. |
| Kick Player Request      | 0x07db   | Yes                | Client requests another player to be kicked.   |
| Character Select Query   | 0x07dc   | Yes                | Client requests info for character selection.  |
| Character Select Commit  | 0x07dd   | Yes                | Client commits character selection.            |
| Map Select Request       | 0x07de   | Yes                | Client requests map select in lobby.           |
+--------------------------+----------+--------------------+------------------------------------------------+

--------------------------------------------------
Account Create Request (0x07d1)
--------------------------------------------------
| Offset | Size | Type       | Field     | Notes              |
|--------|------|------------|-----------|--------------------|
| 0x00   | 2    | uint16     | packet_id | Always 0x07d1      |
| 0x02   | 2    | uint16     | length    | Payload length     |
| 0x04   | 12   | char[12]   | username  | ASCII, zero-padded |
| 0x10   | 12   | char[12]   | password  | ASCII, zero-padded |

--------------------------------------------------
Channel Join Request (0x07d4)
--------------------------------------------------
| Offset | Size | Type     | Field     | Notes        |
|--------|------|----------|-----------|--------------|
| 0x00   | 2    | uint16   | packet_id | 0x07d4       |
| 0x02   | 2    | uint16   | length    | Payload len  |
| 0x04   | 8    | char[8]  | username  | ASCII        |
| 0x14   | 2    | uint16   | channel   | Channel num  |
|  ...   | ...  | ...      | ...       | (Unknown)    |

--------------------------------------------------
Lobby Create Request (0x07d5)
--------------------------------------------------
| Offset | Size | Type     | Field      | Notes                                |
|--------|------|----------|------------|--------------------------------------|
| 0x00   | 2    | uint16   | packet_id  | Always 0x07d5                        |
| 0x02   | 2    | uint16   | length     | Payload length                       |
| 0x04   | 4    | char[4]  | player_id  | ASCII, zero-padded                   |
| 0x08   | 8    | unknown  | (padding?) | (Bytes between player_id & name)     |
| 0x10   | 12   | char[12] | name       | ASCII, zero-padded                   |
| 0x1C   | 8    | char[8]  | password   | ASCII, zero-padded                   |
|  ...   | ...  | ...      | ...        | (Possible padding/unknowns)          |

> - Only upper-case letters/numbers are accepted for name/password.
> - If password is empty, lobby is public; otherwise, private.
> - Lobby is created on the server with a unique `room_id`, and player is added to the players list.

--------------------------------------------------
Lobby Join Request (0x07d6)
--------------------------------------------------
| Offset | Size | Type     | Field      | Notes                                |
|--------|------|----------|------------|--------------------------------------|
| 0x00   | 2    | uint16   | packet_id  | Always 0x07d6                        |
| 0x02   | 2    | uint16   | length     | Payload length                       |
| 0x04   | 4    | char[4]  | player_id  | ASCII, zero-padded                   |
| 0x08   | 16   | unknown  | (padding?) |                                      |
| 0x18   | 12   | char[12] | name       | ASCII, zero-padded                   |
|  ...   | ...  | ...      | ...        | (Possible padding/unknowns)          |

> - Server matches `lobby_name` by raw ASCII comparison.
> - If found and not full, player is added; otherwise, ignored or rejected.

--------------------------------------------------
Game Start Request (0x07d8)
--------------------------------------------------
| Offset | Size | Type     | Field      | Notes                              |
|--------|------|----------|------------|------------------------------------|
| 0x00   | 2    | uint16   | packet_id  | Always 0x07d8                      |
| 0x02   | 2    | uint16   | length     | Payload length (0x000d)            |
| 0x04   | 0x0D | bytes    | player_id  | ASCII, zero-padded (typically 4 bytes, padded to 0x0D with 0x00) |

> - The player ID is the initiating player.
> - Sent when a player clicks "Start Game" or equivalent in the lobby menu.
> - Example: `d8070d0042414241000000000000000000` ("BABA" as player_id)

--------------------------------------------------
Lobby Leave Request (0x07da)
--------------------------------------------------
| Offset | Size | Type     | Field      | Notes                        |
|--------|------|----------|------------|------------------------------|
| 0x00   | 2    | uint16   | packet_id  | Always 0x07da                |
| 0x02   | 2    | uint16   | length     | Payload length (usually 0x0d)|
| 0x04   | 4    | char[4]  | player_id  | ASCII/EUC-KR, zero-padded    |
| 0x08   | ...  | unknown  | padding    | Typically all 0x00           |

- The server must reply with a 0x0bc2 ACK (Lobby Leave Ack).
- After ACK, the server removes the player from the lobby.
- No follow-up packets are required.

--------------------------------------------------
Kick Player Request (0x07db)
--------------------------------------------------
| Offset | Size | Type     | Field        | Notes                                |
|--------|------|----------|--------------|--------------------------------------|
| 0x00   | 2    | uint16   | packet_id    | Always 0x07db                        |
| 0x02   | 2    | uint16   | length       | Payload length (usually 0x04)        |
| 0x04   | 4    | uint32   | player_index | Index of player to remove (0â€“3)      |

- The server must first reply with a 0x0bc3 ACK.
- The server must then remove the player at `player_index` from the lobby and send an updated 0x03ee Lobby Room Info packet to all players in the lobby.

--------------------------------------------------
Character Select Query (0x07dc) 
--------------------------------------------------
| Offset | Size | Type     | Field      | Notes                          |
|--------|------|----------|------------|--------------------------------|
| 0x00   | 2    | uint16   | packet_id  | Always 0x07dc                  |
| 0x02   | 2    | uint16   | length     | Payload length (always 0x08)   |
| 0x04   | 4    | char[4]  | player_id  | ASCII, zero-padded             |

- Sent repeatedly by client during character select menu.
- Server must reply with 0xbc4 (Character Select Setup) for the requested player.

--------------------------------------------------
Character Select Commit (0x07dd) 
--------------------------------------------------
| Offset | Size | Type     | Field      | Notes                          |
|--------|------|----------|------------|--------------------------------|
| 0x00   | 2    | uint16   | packet_id  | Always 0x07dd                  |
| 0x02   | 2    | uint16   | length     | Payload length (always 0x08)   |
| 0x04   | 1    | uint8    | character  | Character value (1-8)          |
| 0x05   | 3    | uint8[3] | padding    | 0x00                           |

- Sent when client confirms character select.
- Server must:
  1. Reply with 0xbc5 (Character Select ACK)
  2. Immediately follow with updated 0x03ee reflecting the change

--------------------------------------------------
Map Select Request (0x07de) 
--------------------------------------------------
| Offset | Size | Type     | Field      | Notes                          |
|--------|------|----------|------------|--------------------------------|
| 0x00   | 2    | uint16   | packet_id  | Always 0x07de                  |
| 0x02   | 2    | uint16   | length     | Payload length (always 0x08)   |
| 0x04   | 4    | uint32le | map_index  | Little-endian (1-5)            |

==================================================================
II.  Server -> Client Packets
==================================================================

+-------------------------------+----------+--------------------+-----------------------------------------------+
| Packet Name                   | PacketID | Structure Defined? | Description                                   |
+-------------------------------+----------+--------------------+-----------------------------------------------+
| Account Create Result         | 0x0bba/9 | Partial            | Account creation success/failure response.    |
| Account Delete Result         | 0x0bba/9 | Partial            | Account deletion success/failure response.    |
| Channel Join Ack              | 0x0bbc   | Yes                | Acknowledges channel join.                    |
| Channel List Response         | 0x0bbb   | Yes                | Returns list of available channels.           |
| Lobby Create Ack              | 0x0bbd   | Yes                | Acknowledges successful lobby creation.       |
| Lobby Join Ack                | 0x0bbe   | Yes                | Acknowledges successful lobby join.           |
| Lobby List Response           | 0x0bc8   | Yes                | Returns list of multiplayer lobbies.          |
| Login Result                  | 0x0bb8   | Yes                | Login result                                  |
| Server List Response          | 0x0bc7   | Yes                | Returns list of available servers.            |
| Game Start Response           | 0x0bc0   | Partial            | Sent in response to Game Start request.       |
| Lobby Leave Ack               | 0x0bc2   | Yes                | Acknowledges lobby leave.                     |
| Kick Player Ack               | 0x0bc3   | Yes                | Acknowledges player kick request.             |
| Character Select Setup        | 0x0bc4   | Yes                | Returns 1 player's info for char select.      |
| Character Select Ack          | 0x0bc5   | Yes                | ACK for character commit.                     |
| Map Select Ack                | 0x0bc6   | Yes                | ACK for map selection.                        |
| Lobby Room State              | 0x03ee   | Yes                | Full lobby state including map/players.       |
+-------------------------------+----------+--------------------+-----------------------------------------------+

--------------------------------------------------
Account Create Result (0x0bba/0x0bb9)
--------------------------------------------------
| Offset | Size | Type     | Field        | Notes                |
|--------|------|----------|--------------|----------------------|
| 0x00   | 2    | uint16   | packet_id    | 0x0bba or 0x0bb9     |
| 0x02   | 2    | uint16   | payload_len  |                      |
| 0x04   | 3    | uint8[3] | code         | 0x01 0x00 0x01/0x00  |
FAILURE CONDITION UNKNOWN

--------------------------------------------------
Account Delete Result (0x0bba/0x0bb9)
--------------------------------------------------
| Offset | Size | Type     | Field        | Notes                |
|--------|------|----------|--------------|----------------------|
| 0x00   | 2    | uint16   | packet_id    | 0x0bba or 0x0bb9     |
| 0x02   | 2    | uint16   | payload_len  |                      |
| 0x04   | 3    | uint8[3] | code         | 0x01 0x00 0x01/0x00  |
FAILURE CONDITION UNKNOWN

--------------------------------------------------
Channel Join Ack (0x0bbc)
--------------------------------------------------
| Offset | Size | Type    | Field       | Notes      |
|--------|------|---------|-------------|------------|
| 0x00   | 2    | uint16  | packet_id   | 0x0bbc     |
| 0x02   | 2    | uint16  | payload_len |            |
| 0x04   | 1    | uint8   | ack         | Always 1   |

--------------------------------------------------
Channel List Response (0x0bbb)
--------------------------------------------------
| Offset | Size    | Type      | Field         | Notes          |
|--------|---------|-----------|---------------|----------------|
| 0x00   | 2       | uint16    | packet_id     | 0x0bbb         |
| 0x02   | 2       | uint16    | payload_len   |                |
| 0x04   | 1       | uint8     | flag          | Always 1       |
| 0x05   | 3       | uint8[3]  | unknown       | Always 0       |
| 0x08   | 12*12   | struct[]  | channel list  | Up to 12       |

Each Channel Entry (12 bytes):
| Offset | Size | Type    | Field        | Notes        |
|--------|------|---------|--------------|--------------|
| 0x00   | 4    | uint32  | index        | Channel idx  |
| 0x04   | 4    | uint32  | cur_players  |              |
| 0x08   | 4    | uint32  | max_players  |              |

--------------------------------------------------
Lobby Create Ack (0x0bbd)
--------------------------------------------------
| Offset | Size | Type    | Field     | Notes                         |
|--------|------|---------|-----------|-------------------------------|
| 0x00   | 2    | uint16  | packet_id | 0x0bbd                        |
| 0x02   | 2    | uint16  | length    | Always 0x0001                 |
| 0x04   | 1    | uint8   | status    | Always 0x01                   |
| 0x05   | 1    | uint8   | status    | Always 0x00                   |
| 0x06   | 1    | uint8   | status    | Always 0x01                   |

> Example (hex): `bd0b010001`

--------------------------------------------------
Lobby Join Ack (0x0bbe)
--------------------------------------------------
| Offset | Size | Type    | Field     | Notes                         |
|--------|------|---------|-----------|-------------------------------|
| 0x00   | 2    | uint16  | packet_id | 0x0bbe                        |
| 0x02   | 2    | uint16  | length    | Always 0x0001                 |
| 0x04   | 1    | uint8   | status    | Always 0x01                   |
| 0x05   | 1    | uint8   | status    | Always 0x00                   |
| 0x06   | 1    | uint8   | status    | Always 0x01                   |

> Example (hex): `be0b010001`

--------------------------------------------------
Lobby List Response (0x0bc8)
--------------------------------------------------
| Offset | Size    | Type      | Field         | Notes            |
|--------|---------|-----------|---------------|------------------|
| 0x00   | 2       | uint16    | packet_id     | 0x0bc8           |
| 0x02   | 2       | uint16    | payload_len   |                  |
| 0x04   | 1       | uint8     | flag          | Always 1         |
| 0x05   | 3       | uint8[3]  | unknown       | Always 0         |
| 0x08   | 44*20   | struct[]  | lobby entries | Up to 20 lobbies |

Each Lobby Entry (44 bytes):
| Offset | Size | Type      | Field      | Notes                                             |
|--------|------|-----------|------------|---------------------------------------------------|
| 0x00   | 4    | uint32    | room_id    |                                                   |
| 0x04   | 4    | uint32    | cur_players|                                                   |
| 0x08   | 4    | uint32    | max_players|                                                   |
| 0x0C   | 16   | char[16]  | name       | EUC-KR, padded 0x00                               |
| 0x1C   | 1    | uint8     | pad1       | Always 0                                          |
| 0x1D   | 12   | char[12]  | password   | EUC-KR, padded 0x00, empty=public, filled=private |
| 0x29   | 1    | uint8     | pad2       | Always 0                                          |
| 0x2A   | 1    | uint8     | status     | 0=Empty, 1=Waiting, 2=Started                     |
| 0x2B   | 1    | uint8     | pad3       | Always 0                                          |

--------------------------------------------------
Login Result (0x0bb8)
--------------------------------------------------
| Offset | Size | Type     | Field       | Notes               |
|--------|------|----------|-------------|---------------------|
| 0x00   | 2    | uint16   | packet_id   | 0x0bb8              |
| 0x02   | 2    | uint16   | payload_len |                     |
| 0x04   | 3    | uint8[3] | code        | 0x01 0x00 0x01/0x00 |

--------------------------------------------------
Server List Response (0x0bc7)
--------------------------------------------------
| Offset | Size    | Type      | Field      | Notes          |
|--------|---------|-----------|------------|----------------|
| 0x00   | 2       | uint16    | packet_id  | 0x0bc7         |
| 0x02   | 2       | uint16    | payload_len|                |
| 0x04   | 1       | uint8     | flag       | Always 1       |
| 0x05   | 3       | uint8[3]  | unknown    | Always 0       |
| 0x08   | 44*10   | struct[]  | servers    | Up to 10       |

Each Server Entry (44 bytes):
| Offset | Size | Type      | Field      | Notes                |
|--------|------|-----------|------------|----------------------|
| 0x00   | 16   | char[16]  | name       | EUC-KR, padded 0x00  |
| 0x10   | 5    | uint8[5]  | reserved   | 0x00                 |
| 0x15   | 16   | char[16]  | ip_ascii   | ASCII IP+null, pad   |
| 0x25   | 3    | uint8[3]  | reserved2  | 0x00                 |
| 0x28   | 4    | int32     | avail      | -1, 0, 1, 2          |

--------------------------------------------------
Character Select Setup (0x0bc4)
--------------------------------------------------
| Offset | Size | Type     | Field      | Notes                                    |
|--------|------|----------|------------|------------------------------------------|
| 0x00   | 2    | uint16   | packet_id  | 0x0bc4                                   |
| 0x02   | 2    | uint16   | payload_len| 0x24 (36)                                |
| 0x04   | 1    | uint8    | flag       | Always 1                                 |
| 0x05   | 3    | uint8[3] | unknown    | Always 0                                 |
| 0x08   | 28   | struct   | player     | See 03ee player block, for 1 player only |

Player Block (28 bytes; see also 03ee):
| Offset | Size | Type    | Field      | Notes                                    |
|--------|------|---------|------------|------------------------------------------|
| 0x00   | 8    | char[8] | player_id  | ASCII, zero-padded                       |
| 0x08   | 5    | uint8   | reserved   | Always 0                                 |
| 0x0D   | 1    | uint8   | character  | 1-8                                      |
| 0x0E   | 1    | uint8   | status     | 0=not ready, 1=ready                     |
| 0x0F   | 1    | uint8   | padding    | Always 0                                 |
| 0x10   | 4    | uint32  | rank       | Only LSB used                            |
| 0x14   | 4    | uint32  | unknown2   | Always 0                                 |
| 0x18   | 4    | uint32  | unknown3   | Always 0                                 |

--------------------------------------------------
Game Start Response (0x0bc0)
--------------------------------------------------
| Offset | Size | Type      | Field        | Notes                                           |
|--------|------|-----------|--------------|-------------------------------------------------|
| 0x00   | 2    | uint16    | packet_id    | Always 0x0bc0                                   |
| 0x02   | 2    | uint16    | payload_len  | Typically 0x0016 (22) or 0x0018 (24)            |
| 0x04   | 4    | uint8[4]  | flag         | Always 0x01 0x00 0x00 0x00                      |
| 0x08   | 0x10 | bytes     | player_id    | Copied from request, 0x10 bytes (padded with 0) |
| 0x18   | 2    | uint16    | param_3      | (uncertain meaning)                             |
| 0x1A   | 2    | uint16    | param_4      | (uncertain meaning)                             |
| 0x1C   | 2    | int16     | param_5      | (uncertain meaning)                             |

> - The client expects a 16 byte payload. Sending the player_id with padding for now...
> - Example response (for "BABA"):
>   `c00b180001000000424142410000000000000000000000000000000000000000`

--------------------------------------------------
Lobby Leave Ack (0x0bc2)
--------------------------------------------------
| Offset | Size | Type     | Field     | Notes                       |
|--------|------|----------|-----------|-----------------------------|
| 0x00   | 2    | uint16   | packet_id | 0x0bc2                      |
| 0x02   | 2    | uint16   | length    | Always 0x0006               |
| 0x04   | 4    | uint8[4] | flag      | Always 0x01 00 00 00        |
| 0x08   | 2    | uint16   | status    | Always 0x0001               |

--------------------------------------------------
Kick Player Ack (0x0bc3)
--------------------------------------------------
| Offset | Size | Type     | Field     | Notes                       |
|--------|------|----------|-----------|-----------------------------|
| 0x00   | 2    | uint16   | packet_id | 0x0bc3                      |
| 0x02   | 2    | uint16   | length    | Always 0x0006               |
| 0x04   | 4    | uint8[4] | flag      | Always 0x01 00 00 00        |
| 0x08   | 2    | uint16   | status    | Always 0x0001               |

--------------------------------------------------
Character Select Ack (0x0bc5)
--------------------------------------------------
| Offset | Size | Type     | Field      | Notes                                    |
|--------|------|----------|------------|------------------------------------------|
| 0x00   | 2    | uint16   | packet_id  | 0x0bc5                                   |
| 0x02   | 2    | uint16   | payload_len| 0x06                                     |
| 0x04   | 1    | uint8    | flag       | Always 1                                 |
| 0x05   | 3    | uint8[3] | unknown    | Always 0                                 |
| 0x08   | 2    | uint16   | value      | Always 1                                 |

--------------------------------------------------
Map Select Ack (0x0bc6)
--------------------------------------------------
Same as 0x0bc5 but packet_id is 0x0bc6.

--------------------------------------------------
Lobby Room State (0x03ee)
--------------------------------------------------
| Offset | Size    | Type      | Field         | Notes                                  |
|--------|---------|-----------|---------------|----------------------------------------|
| 0x00   | 2       | uint16    | packet_id     | 0x03ee                                 |
| 0x02   | 2       | uint16    | payload_len   | 0x9c                                   |
| 0x04   | 1       | uint8     | lobby_leader  | 0,1,2,3                                |
| 0x05   | 3       | uint8[3]  | padding       | Always 0                               |
| 0x08   | 16      | char[16]  | lobby_name    | EUC-KR, padded 0x00                    |
| 0x18   | 16      | uint8[16] | unknown       | Always 0                               |
| 0x28   | 28*4    | struct[]  | players       | Up to 4                                |
| 0x98   | 4       | uint32le  | map_select    | 1-5                                    |
| 0x9c   | 4       | uint32le  | lobby_flag    | Usually 1                              |

Player Block (see above).

==================================================================
Character/Map Select Protocol (v0.6.6)
==================================================================
- For character select, the client will loop sending 0x07dc packets (one per player).
- The server must reply to each 0x07dc with a 0x0bc4 containing the exact playerâ€™s info.
- Once the user chooses a character and presses confirm, the client sends a 0x07dd with the new character value.
- Server must ACK with 0x0bc5, then immediately update the relevant playerâ€™s character field and send a new 0x03ee lobby room packet.
- Map select uses a nearly identical handshake: 0x07de â†’ 0x0bc6 â†’ 0x03ee (with updated map_idx).

==================================================================
Notes
==================================================================
- All packets start with a 2-byte packet ID and 2-byte payload length (little-endian).
- "Yes" under "Structure Defined?" means a struct is present in the code.
- "No" means only the ID is checked; usually just a request header.
- Unused fields/padding are typically 0x00.
- Multi-entry responses (server/channel/lobby lists) are padded with blank entries.
- Strings are EUC-KR or ASCII, zero-padded.
- Lobby structure on server tracks: room_id, name, password, max_players, current_players, and players (list of player IDs).
- If password is empty, lobby is public; otherwise, private.
- When a player joins a lobby, current_players is incremented. If full, join is rejected.
- Lobby status: 0 = Empty, 1 = Waiting, 2 = Started.
- Fields are always padded with 0x00 (never 0x11).